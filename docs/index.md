# Prepare Scattering Matrices (Go version)

## Для чего он нужен?

Моя команда используем модель MCPOLART для асчета переноса солнечной 
радиации в системе атмосфера-подстилающая поверхность. Сама модель - 
векторная, то есть вычисляет перенос не интенсивности, а всех
компонентов вектора Стокса <i>S=[I, Q, U, V]</i>. В случае солнечного
излучения на верхней границе атмосферы вектор сторка будет иметь вид
<i>S=[1.0,0,0]</i>. В результате распространения излучения и рассеяния
на частицах аэрозоля и молекулах, вектор стокса каким-то образом
трансформируется в вектор <i>S<sup>'</sup>=[I, Q, U, V]</i>.

Для работы этой модели необходимо иметь матрицы рассеяния для 
аэрозольных слоев, располагаемых в атмосфере. Для случайно-ориенированных 
частиц ненулевыми будут только 6 компонент из 16, а именно: 
S<sub>11</sub>, S<sub>12</sub>, S<sub>22</sub>, S<sub>33</sub>, 
S<sub>34</sub>, S<sub>44</sub>.

Само же распределение частиц по размерам определяется микрофизичскими 
хаактеристиками, такими как комплексный показатель преломления m, 
функция распрелеления частиц по размерам, форма частиц. Имея эти 
параметры, мы можем вычислить матрицы рассеяния, а уже имея матрицы 
рассеяния, программный код MCPOLART определит регистрируемый 
приемником вектор Стокса. 

Эта программа решает следующую заадачу: на основе данных AERONET 
вычисляет оптические свойства заданного распределения частиц по
размерам, в том числе, вычисляет матрицы рассеяния.

## Как ей пользоваться?

Если у вас Windows - просто [скачайте](https://github.com/DrShmirko/go-prepare-scattering-matrices/releases/download/v0.3.0/go-prepare-scattering-matrices.7z) и распакуйте архив в любую директорию. После этого у вас должна получится такая структура каталогов:

```bash
--+- prepare-mueller-matrices*
  |
  +- KRNLS_arnt_sphrds
  |
  +- KRNLS_arnt_sphrs
  |
  +- libspheroid.so/libspheroid.dll
```
Исполняеый файл отмечен звездочкой.

```bash
Usage of ./prepare-mueller-matrices:
  -matdir string
        Каталог, для сохранения матриц. (default "./out")
  -picdir string
        Каталог, для сохранения графиков. (default "./pic")
  -sf float
        Пороговое значение сферичности. (default 1)
  -skip int
        Сколько строк пропускать. (default 6)
  -wvl float
        Длина волны для расчета матриц. (default 0.87)
```

Как видите, всего несолько параметров контролирует выполнение программы,  
а именно: длина волны (wvl), skip и сферичность (sf). 

*Как работает программа:* она открывает файл, переданный ей в качестве 
аргумента, пропускает *skip* строк, читает следующую строку и трактует 
ее как заголовок. Далее читает оставшиеся строки и разбирает их на 
столбцы. Далее, на основе сферичности sf удаляет те измерения, 
где сферичность больше sf. К оставшимся измерениям применяется функция 
расчета оптических параметров. сначала идет расчет на смеси сфероидов 
Дубовика, а затем - на сферах.

Далее эти матрицы сводятся воедино, исходя их величины сферичности.
Например: 

&alpha;<sub>ext</sub><sup>tot</sup> = sf &alpha;<sub>ext</sub><sup>spheres</sup> + (1-sf) &alpha;<sub>ext</sub><sup>spheroids</sup>

&alpha;<sub>sca</sub><sup>tot</sup> = sf &alpha;<sub>sca</sub><sup>spheres</sup> + (1-sf) &alpha;<sub>aca</sub><sup>spheroids</sup>

&alpha;<sub>abs</sub><sup>tot</sup> = sf &alpha;<sub>abs</sub><sup>spheres</sup> + (1-sf) &alpha;<sub>abs</sub><sup>spheroids</sup>

И, наконец, матрицы рассеяния также трансформируются:
M<sup>tot</sup> = sf M<sup>spheres</sup> + (1-sf) M<sup>spheroids</sup>

Остальные величины вычисляются из основных.
&beta; = &alpha; / LR

&mu;<sub>l</sub>(180<sup>o</sup>) = (S<sub>11</sub>(180<sup>o</sup>)-S<sub>22</sub>(180<sup>o</sup>))/(S<sub>11</sub>(180<sup>o</sup>)+S<sub>22</sub>(180<sup>o</sup>))


В результете расчетов появляются картинки в трех форматах: txt, png и
svg.
```text

                                  Polarization                                  
                                                                                
                                                                                
      50  +                                                                     
          |                                                                     
          |                                                                     
          |                                #######                              
      40  +                              ###      ##                            
          |                             ##         ##                           
          |                           ###           ##                          
      30  +                          ##               #                         
          |                         ##                ##                        
 D        |                        ##                  ##                       
 O        |                      ##                     #                       
 P    20  +                     ##                       #                      
 ,        |                    ##                         #                     
          |                  ##                           ##            #       
 %    10  +                ###                             #           # #      
          |              ###                                #          # #      
          |          ####                                   ##         #  #     
          | ##########                                       ##       #   #     
       0  ###- - - - - - - - - - - - - - - - - - - - - - - - -#- - - -#- -#-#   
          |                                                    #      #   # #   
          |                                                    ##     #    #    
     -10  +                                                      #   #     #    
          |                                                      ##  #          
          |                                                       ###           
     -20  +----------+----------+----------+----------+----------+----------+   
          0         30         60         90         120        150        180  
                                   Scattering angle                             

```



 ### Что изменилось в версии 0.5.0:

- Матрицы рассеяния приведены к виду, используемому в MCPOLART.
- Добавлены обработчики ошибок во время сохранения файлов.




